<!--
Checkout form element stripe api
@tfarirayi1
-->

<!-- Polymer dependency -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- Iron elements -->
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<!-- Paper elements -->
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!-- Custom elements -->
<link rel="import" href="aws-sdk.html">
<link rel="import" href="stripe-sdk.html">
<link rel="import" href="my-icons.html">

<dom-module id="checkout-form">
  <template>
    <style include="my-styles">
      :host {
        display: block;
        background-color: #455A64;
        border: 1px solid rgba(255,138,101 ,1);
        border-radius: 8px;
        box-sizing: border-box;
        margin-left: auto;
        margin-right: auto;
        margin-top: -13px;
        max-width: 300px;
        padding-top: 13px;
        @apply(--shadow-elevation-2dp);                                                                 
      }

      .dot {
          border-bottom: 1px solid #607D8B;
          margin-top: 21px;
          margin-bottom: 21px;
          width: 1px;
          margin-left: auto;
          margin-right: auto;
      }

      paper-input-container {
          text-align: left;
          /* Mixins */
          --paper-input-container-invalid-color: #BF360C;

          --paper-input-container-color: rgba(176,190,197 ,1);

          --paper-input-container-focus-color: rgba(38,50,56 ,1);

          --paper-input-container-label-focus: {
              color: rgba(255,138,101 ,1);
          };

          --paper-input-container-label: {
              font-size: 18px;
              letter-spacing: 1px;
              color: rgba(144,164,174 ,1);
              font-family: 'Roboto', monospace;
          };

          --paper-input-container-input: {
              color: rgba(236,239,241 ,1);
          };
      }

      .pay-section {
        color: rgba(207,216,220 ,1);
        font-family: 'Raleway', sans-serif;
        font-size: 14px;
        padding: 21px 13px 21px 13px;
        text-align: center;
        @apply(--layout-vertical);
        
      }

      .section {
        box-sizing: border-box;
        color: rgba(207,216,220 ,1);
        font-family: 'Raleway', sans-serif;
        font-size: 16px;
        margin-top: 13px;
        padding: 0px 13px 21px 13px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
      }

      .title {
        max-width: 200px;
        line-height: 150%;
        margin-left: 0;
        letter-spacing: 1px;
      }

      .toggle {
        box-sizing: border-box;
      }

      paper-button.billing {
        border-radius: 0px;
        color: rgba(176,190,197 ,1);
        color: rgba(33,33,33 ,1);
        font-size: 12px;
        max-width: 120px;
        min-width: 120px;
        text-align: center;
        text-transform: none;
        width: fit-content;
      }

      paper-button.billing:focus {
        font-weight: normal;
      }

      paper-button.pay {
        background-color: rgba(38,50,56 ,0.9);
        border-radius: 2px;
        color: rgba(255,138,101 ,1);
        font-size: 13px;
        font-family: 'Raleway', sans-serif;
        letter-spacing: 1px;
        margin-top: 13px;
        margin-left: auto;
        margin-right: auto;
        width: 72%;
      }

      paper-button.pay[disabled] {
        background-color: rgba(38,50,56 ,0.4);
        color: rgba(255,138,101 ,0.7);
      }

      paper-button.pay:focus {
        font-weight: normal;
      }

      iron-icon {
        --iron-icon-height: 15px;
        --iron-icon-width: 15px;
      }

      .field {
        padding-left: 15px;
        padding-right: 15px;
      }

      .spacer {
        @apply(--layout-flex);
      }

      .form {
        padding: 0px 15px;
        color: white;
      }

      .card {
        background-color: rgba(38,50,56 ,0.9);
        padding: 13px 8px;
        margin-left: 13px;
        border-radius: 10px 0px 0px 10px;
      }

      .stripe-label {
        font-size: 14px;
        letter-spacing: 1px;
        color: rgba(207,216,220 ,0.9);
        color: rgba(255,138,101 ,1);
        font-family: 'Roboto', monospace;
        line-height: 150%;
        
      }
    </style>
    <!-- Dom here -->

    <div class="section title">
      <span>Your Details</span>
      <span class="spacer"></span>
    </div>

    <div class="field">

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>First Name:</label>
          <input is="iron-input" type="text" spellcheck="false" bind-value="{{customerFirst}}">
      </paper-input-container>

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>Last Name:</label>
          <input is="iron-input" type="text" spellcheck="false" bind-value="{{customerLast}}">
      </paper-input-container>

      <!-- Email field -->
      <paper-input-container  always-float-label>
          <label>Email Address:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{customerEmail}}">
      </paper-input-container>
    </div>

    <div class="dot"></div>

    <div class="section title">
      <span>[[addressTitle]]</span>
      <span class="spacer"></span>
    </div>
    
    <div class="field">
      <paper-input-container  always-float-label>
          <label>Address Line 1:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryLineA}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Address Line 2:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryLineB}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>City:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryCity}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Postcode:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryPostcode}}">
      </paper-input-container>
    </div>

  <template is="dom-if" if="[[hasBilling]]">
    <div class="dot"></div>
   <div class="section">
      <span>Billing Address</span>
      <span class="spacer"></span>
    </div>
    
    <div class="field">
      <paper-input-container  always-float-label>
          <label>Address Line 1:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingLineA}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Address Line 2:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingLineB}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>City:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingCity}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Postcode:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingPostcode}}">
      </paper-input-container>
    </div>
  </template>
    
    <div class="section toggle">
      <paper-button class="billing" on-click="_toggleBilling" noink>[[toggleTitle]]</paper-button>
    </div>

    <form id="payment_form" class="form card">
      <div class="stripe-group">
        <label class="stripe-label">Card Number:</label>
        <content select="#card_code"></content>
      </div>
      <div class="stripe-group">
        <label class="stripe-label">Expiry Date:</label>
        <content select="#card_date"></content>
      </div>
      <div class="stripe-group">
        <label class="stripe-label">CVC:</label>
        <content select="#card_sec"></content>
      </div>
    </form>

  <div class="pay-section">
    <content select="#card_errors"></content>
    [[test]]
    <paper-button id="pay_now" class="pay">Pay Now</paper-button>
  </div>

  </template>

  <script>
    Polymer({
      is: 'checkout-form',
      
      properties: {

        addressTitle: {
          type: Boolean,
          computed: '_computeAddress(hasBilling)'
        },

        toggleTitle: {
          type: String,
          computed: '_computeToggleTitle(hasBilling)'          
        },

        order: {
          type: String,
          computed: '_computeOrder(customerFirst, customerLast, customerEmail, deliveryLineA, deliveryLineB, deliveryCity, deliveryPostcode, billingLineA, billingLineB, billingCity, billingPostcode)'
        },

        hasBilling: {
          type: Boolean,
          value: false
        },

        customerFirst: {
          type: String,
          value: '',
        },

        customerLast: {
          type: String,
          value: '',
        },

        customerEmail: {
          type: String,
          value: '',
        },

        deliveryLineA: {
          type: String,
          value: '',
        },

        deliveryLineB: {
          type: String,
          value: '',
        },

        deliveryCity: {
          type: String,
          value: '',
        },

        deliveryPostcode: {
          type: String,
          value: '',
        },

        billingLineA: {
          type: String,
          value: '',
        },

        billingLineB: {
          type: String,
          value: '',
        },

        billingCity: {
          type: String,
          value: '',
        },

        billingPostcode: {
          type: String,
          value: '',
        },

        basketData: {
          type:Array
        },
        
        totalCost: {
          type: Number
        },

        errorMessage: {
          type: String,
          value: 'Hey',
          notify: true
        },

        submitUrl: {
          type: String,
          value: 'https://j2su17zxab.execute-api.eu-west-1.amazonaws.com/prod/StripeService'
        },

      },

      _computeOrder: function(customerFirst, customerLast, customerEmail, deliveryLineA, deliveryLineB, deliveryCity, deliveryPostcode, billingLineA, billingLineB, billingCity, billingPostcode) {
        var order = {
          items: this.basketData,
          cost: this.totalCost * 100,
          customer: {
            firstName: customerFirst,
            lastName: customerLast,
            email: customerEmail
          },
          deliveryAddress: {
            addressOne: deliveryLineA,
            addressTwo: deliveryLineB,
            city: deliveryCity,
            postcode: deliveryPostcode
          },
          billingAddress: {
            addressOne: billingLineA,
            addressTwo: billingLineB,
            city: billingCity,
            postcode: billingPostcode
          }
        };

        return JSON.stringify(order);
      },

      _computeAddress: function(check) {
        return check ? this.addressTitle = 'Delivery Address' : this.addressTitle = 'Delivery & Billing Address';
      },

      _computeToggleTitle: function(check) {
        return check ? 'Single Address?' : 'Separate Billing Address?';
      },

      _toggleBilling: function() {
        this.hasBilling = !this.hasBilling;
      },

      created: function() {
        // AWS Identity Check
        AWS.config.region = 'eu-west-1'; // Region
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'eu-west-1:29a3ccbb-f1e8-4801-87cb-171af721855a'
        });

      },

      ready: function() {

        var main = this;
        var stripe = Stripe('pk_test_iFA4WGrOjzFb9pgHretwnXlq');
        var elements = stripe.elements();

        var card_num = this.queryEffectiveChildren('#card_code');
        var card_exp = this.queryEffectiveChildren('#card_date');
        var card_cvc = this.queryEffectiveChildren('#card_sec');
        var error_el = this.queryEffectiveChildren('#card_errors');
        var paymentButton = this.$.pay_now;
        
        var style = {
          style: {
            base: {
              fontSize: '16px',
              lineHeight: '24px',
              color: 'rgba(236,239,241 ,1)',
              '::placeholder': {
                color: 'rgba(69,90,100 ,1)',
              },
            }
          }
        };

        // Create Stripe elements from raw elements
        var cardNumber = elements.create('cardNumber', style);
        var cardExpiry = elements.create('cardExpiry', style);
        var cardCvc = elements.create('cardCvc', style);

        // Mount elements
        cardNumber.mount(card_num);
        cardExpiry.mount(card_exp);
        cardCvc.mount(card_cvc);

        cardNumber.addEventListener('change', function(event) {
          error_el.textContent = event.error ? event.error.message : '';
        });
        
        // cardCvc.addEventListener('change', function(event) {
        //   error_el.textContent = event.error ? event.error.message : '';
        // });

        paymentButton.addEventListener('click', function(event) {
          // main.$.pay_now.setAttribute('disabled', false);
          error_el.textContent = 'Creating Token';
          
          stripe.createToken(cardNumber).then(function(result) {
            if (result.error) {
              // Inform the user if there was an error
              // setTimeout(function(){ main.$.pay_now.removeAttribute('disabled'); }, 5000);
              error_el.textContent = result.error.message;
              
            } else {
              // Send the token.id to your server
              error_el.textContent = 'Submitting Payment...';
              submitToken(result.token);
            }
          });

        });

        // Submit function
        function submitToken(token) {
          
          // Lambda service object
          var lambda = new AWS.Lambda({
              region: 'eu-west-1',
              apiVersion: '2015-03-31'
          });

          // Lambda invoke params
          var lambdaParams = {
              FunctionName : 'pay-stripe',
              InvocationType : 'RequestResponse',
              LogType: 'Tail',
              Payload: JSON.stringify({
                  "order": main.order,
                  "token": token.id
              }),
          };

          // Lambda invoke!
          lambda.invoke(lambdaParams, function(err, data) {
            if (err) {
                main.$.pay_now.removeAttribute('disabled'); 
            } else {
              var result = JSON.parse(data.Payload)
              result.type === 'authorized' ? error_el.textContent = result.seller_message : error_el.textContent = result.message;
              console.log(result);
            }

          });

        }

      }

    });
  </script>
</dom-module>
