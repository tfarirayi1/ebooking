<!--
Checkout form element stripe api
@tfarirayi1
-->

<!-- Polymer dependency -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- Iron elements -->
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<!-- Paper elements -->
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<!-- Custom elements -->
<link rel="import" href="aws-sdk.html">
<link rel="import" href="stripe-sdk.html">

<dom-module id="checkout-form">
  <template>
    <style>
      :host {
        display: block;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ECEFF1;
        border-radius: 8px;
        padding: 13px;
        margin-top: -13px;
        box-sizing: border-box;
        border: 1px solid #CFD8DC;
        background-color: #455A64;
        @apply(--shadow-elevation-2dp);                                                                 
      }
    </style>
    <!-- Dom here -->

    <div class="main">
      <!-- Email field -->
      <paper-input-container  always-float-label>
          <label>Email Address:</label>
          <input is="iron-input" type="email" prevent-invalid-input on-input="revalidate" spellcheck="false" label="Email" bind-value="{{email}}">
      </paper-input-container>

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>First Name:</label>
          <input is="iron-input" type="email" prevent-invalid-input on-input="revalidate" spellcheck="false" label="Email" bind-value="{{email}}">
      </paper-input-container>

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>Last Name:</label>
          <input is="iron-input" type="email" prevent-invalid-input on-input="revalidate" spellcheck="false" label="Email" bind-value="{{email}}">
      </paper-input-container>
    </div>
    
    <label for="payment_form">Payment Details</label>

    <form action="[[submitUrl]]" method="post" id="payment_form">
      <content></content>
      <paper-button>Submit Payment</paper-button>
    </form>
 
  </template>

  <script>
    Polymer({
      is: 'checkout-form',
      
      properties: {
        basketData: Array,
        
        totalCost: Number,

        totalItems: Number,

        errorMessage: {
          type: String,
          value: 'Hey',
          notify: true
        },

        submitUrl: {
          type: String,
          value: 'https://j2su17zxab.execute-api.eu-west-1.amazonaws.com/prod/StripeService'
        }

      },

      ready: function() {
        // AWS Identity Check
        AWS.config.region = 'eu-west-1'; // Region
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'eu-west-1:29a3ccbb-f1e8-4801-87cb-171af721855a'
        });

        var main = this;
        var stripe = Stripe('pk_test_iFA4WGrOjzFb9pgHretwnXlq');
        var elements = stripe.elements();

        var card_el = this.queryEffectiveChildren('#card_element');
        var error_el = this.queryEffectiveChildren('#card_errors');
        var form = this.$.payment_form;

        var card = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              lineHeight: '24px'
            }
          }
        });

        card.mount(card_el);
        card.addEventListener('change', function(event) {
          console.log(event);
          if (event.error) {
            error_el.textContent = event.error.message;

          } else {
            error_el.textContent = '';
            
          }
        });

        form.addEventListener('submit', function(event) {
          event.preventDefault();
          stripe.createToken(card).then(function(result) {
            if (result.error) {
              // Inform the user if there was an error
              error_el.textContent = result.error.message;

            } else {
              // Send the token to your server
              console.log(result);
              stripeTokenHandler(result.token);
            }
          });
        });

        function stripeTokenHandler(token) {
          // Insert the token ID into the form so it gets submitted to the server
          var hiddenInput = document.createElement('input');
          hiddenInput.setAttribute('type', 'hidden');
          hiddenInput.setAttribute('name', 'stripeToken');
          hiddenInput.setAttribute('value', token.id);
          form.appendChild(hiddenInput);

          console.log(token.id);
          // Submit the form
          // form.submit();
        }

      }

    });
  </script>
</dom-module>
