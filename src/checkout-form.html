<!--
Checkout form element stripe api
@tfarirayi1
-->

<!-- Polymer dependency -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- Iron elements -->
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<!-- Paper elements -->
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!-- Custom elements -->
<link rel="import" href="aws-sdk.html">
<link rel="import" href="stripe-sdk.html">
<link rel="import" href="my-icons.html">

<dom-module id="checkout-form">
  <template>
    <style>
      :host {
        display: block;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ECEFF1;
        border-radius: 8px;
        padding-top: 13px;
        margin-top: -13px;
        box-sizing: border-box;
        border: 1px solid #CFD8DC;
        border: 1px solid rgba(255,138,101 ,1);
        background-color: #455A64;
        @apply(--shadow-elevation-2dp);                                                                 
      }

      .dot {
          border-bottom: 1px solid #607D8B;
          margin-top: 21px;
          margin-bottom: 21px;
          width: 1px;
          margin-left: auto;
          margin-right: auto;
      }

      paper-input-container {
          text-align: left;
          /*font-size: 15px;*/
          --paper-input-container-input: {
              color: rgba(236,239,241 ,1);

          };
          --paper-input-container-invalid-color: #BF360C;
          --paper-input-container-color: rgba(176,190,197 ,1);
          --paper-input-container-focus-color: rgba(38,50,56 ,1);

          --paper-input-container-label-focus: {
              color: rgba(236,239,241 ,1);
              color: rgba(207,216,220 ,1);
              color: rgba(255,171,145 ,1);
              color: rgba(255,138,101 ,1);
              
          }
          /*--paper-input-container-underline: {

              background-color: rgba(236,239,241 ,1);
              background-color: rgba(176,190,197 ,1);
              background-color: rgba(69,90,100 ,1);
              color: red;
          }*/
          --paper-input-container-label: {
              font-size: 18px;
              letter-spacing: 1px;
              color: rgba(207,216,220 ,0.9);
              color: rgba(255,138,101 ,1);
              color: rgba(144,164,174 ,1);
              font-family: 'Roboto', monospace;
          }
      }

      .section {
        box-sizing: border-box;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        margin-top: 13px;
        padding: 0px 13px 21px 13px;
        color: rgba(207,216,220 ,1);
        font-size: 16px;
        font-family: 'Cabin', sans-serif;
        font-family: 'Raleway', sans-serif;
      }

      .title {
        max-width: 200px;
        line-height: 150%;
        margin-left: 0;
        letter-spacing: 1px;
      }

      .toggle {
        box-sizing: border-box;
      }

      paper-button.billing {
        width: fit-content;
        text-transform: none;
        font-size: 12px;
        border-radius: 0px;
        min-width: 120px;
        max-width: 120px;
        text-align: center;
        color: rgba(144,164,174 ,1);
        color: rgba(176,190,197 ,1);
        /*background-color: rgba(144,164,174 ,1);*/
      }

      paper-button.billing:focus {
        font-weight: normal;
      }

      paper-button.pay:focus {
        font-weight: normal;
      }

      paper-button.pay {
        border-radius: 2px;
        font-size: 13px;
        font-family: 'Roboto Condensed', sans-serif;
        font-family: 'Raleway', sans-serif;
        color: rgba(255,138,101 ,1);
        background-color: rgba(38,50,56 ,0.9);
        width: 72%;
        margin: auto;
        /*padding: 13px 21px 21px 13px;*/
        letter-spacing: 1px;
      }

      iron-icon {
        --iron-icon-height: 15px;
        --iron-icon-width: 15px;
      }

      .field {
        padding-left: 15px;
        padding-right: 15px;
      }

      .spacer {
        @apply(--layout-flex);
      }

      .form {
        padding: 0px 15px;
        color: white;
      }

      .card {
        background-color: rgba(38,50,56 ,0.9);
        padding: 13px 8px;
        margin-left: 13px;
        border-radius: 10px 0px 0px 10px;
      }

      .stripe-label {
        font-size: 14px;
        letter-spacing: 1px;
        color: rgba(207,216,220 ,0.9);
        color: rgba(255,138,101 ,1);
        font-family: 'Roboto', monospace;
        line-height: 150%;
        
      }
    </style>
    <!-- Dom here -->

    <div class="section title">
      <span>Your Details</span>
      <span class="spacer"></span>
    </div>

    <div class="field">

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>First Name:</label>
          <input is="iron-input" type="text" spellcheck="false" bind-value="{{customerFirst}}">
      </paper-input-container>

      <!-- Name field -->
      <paper-input-container  always-float-label>
          <label>Last Name:</label>
          <input is="iron-input" type="text" spellcheck="false" bind-value="{{customerLast}}">
      </paper-input-container>

      <!-- Email field -->
      <paper-input-container  always-float-label>
          <label>Email Address:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{customerEmail}}">
      </paper-input-container>
    </div>

    <div class="dot"></div>

    <div class="section title">
      <span>[[addressTitle]]</span>
      <span class="spacer"></span>
    </div>
    
    <div class="field">
      <paper-input-container  always-float-label>
          <label>Address Line 1:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryLineA}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Address Line 2:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryLineB}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>City:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryCity}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Postcode:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{deliveryPostcode}}">
      </paper-input-container>
    </div>

  <template is="dom-if" if="[[hasBilling]]">
    <div class="dot"></div>
   <div class="section">
      <span>Billing Address</span>
      <span class="spacer"></span>
    </div>
    
    <div class="field">
      <paper-input-container  always-float-label>
          <label>Address Line 1:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingLineA}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Address Line 2:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingLineB}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>City:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingCity}}">
      </paper-input-container>

      <paper-input-container  always-float-label>
          <label>Postcode:</label>
          <input is="iron-input" type="email" spellcheck="false" bind-value="{{billingPostcode}}">
      </paper-input-container>
    </div>
  </template>
    
    <div class="section toggle">
      <paper-button class="billing" on-click="_toggleBilling" noink>[[toggleTitle]]</paper-button>
    </div>

    <form id="payment_form" class="form card">
      <div class="stripe-group">
        <label class="stripe-label">Card Number:</label>
        <content select="#card_code"></content>
      </div>
      <div class="stripe-group">
        <label class="stripe-label">Expiry Date:</label>
        <content select="#card_date"></content>
      </div>
      <div class="stripe-group">
        <label class="stripe-label">CVC:</label>
        <content select="#card_sec"></content>
      </div>
      <div class="stripe-group">
        <label class="stripe-label">Errors:</label>
        <content select="#card_errors"></content>
      </div>
    </form>

  <div class="section">
    <paper-button id="pay_now" class="pay">Pay Now</paper-button>
  </div>

  </template>

  <script>
    Polymer({
      is: 'checkout-form',
      
      properties: {

        addressTitle: {
          type: Boolean,
          computed: '_computeAddress(hasBilling)'
        },

        toggleTitle: {
          type: String,
          computed: '_computeToggleTitle(hasBilling)'          
        },

        order: {
          type: String,
          computed: '_computeOrder(customerFirst, customerLast, customerEmail, deliveryLineA, deliveryLineB, deliveryCity, deliveryPostcode, billingLineA, billingLineB, billingCity, billingPostcode)'
        },

        hasBilling: {
          type: Boolean,
          value: false
        },

        customerFirst: {
          type: String,
          value: '',
        },

        customerLast: {
          type: String,
          value: '',
        },

        customerEmail: {
          type: String,
          value: '',
        },

        deliveryLineA: {
          type: String,
          value: '',
        },

        deliveryLineB: {
          type: String,
          value: '',
        },

        deliveryCity: {
          type: String,
          value: '',
        },

        deliveryPostcode: {
          type: String,
          value: '',
        },

        billingLineA: {
          type: String,
          value: '',
        },

        billingLineB: {
          type: String,
          value: '',
        },

        billingCity: {
          type: String,
          value: '',
        },

        billingPostcode: {
          type: String,
          value: '',
        },

        basketData: Array,
        
        totalCost: Number,

        errorMessage: {
          type: String,
          value: 'Hey',
          notify: true
        },

        submitUrl: {
          type: String,
          value: 'https://j2su17zxab.execute-api.eu-west-1.amazonaws.com/prod/StripeService'
        },

      },

      _computeOrder: function(customerFirst, customerLast, customerEmail, deliveryLineA, deliveryLineB, deliveryCity, deliveryPostcode, billingLineA, billingLineB, billingCity, billingPostcode) {
        var order = {
          "order": this.basketData,
          "cost": this.totalCost,
          "customer": {
            "firstName": customerFirst,
            "lastName": customerLast
          },
          "deliveryAddress": {
            "addressOne": deliveryLineA,
            "addressTwo": deliveryLineB,
            "city": deliveryCity,
            "postcode": deliveryPostcode
          },
          "billingAddress": {
            "addressOne": billingLineA,
            "addressTwo": billingLineB,
            "city": billingCity,
            "postcode": billingPostcode
          }
        };

        return JSON.stringify(order);
      },

      _computeAddress: function(check) {
        return check ? this.addressTitle = 'Delivery Address' : this.addressTitle = 'Delivery & Billing Address';
      },

      _computeToggleTitle: function(check) {
        return check ? 'Single Address?' : 'Separate Billing Address?';
      },

      _toggleBilling: function() {
        this.hasBilling = !this.hasBilling;
      },

      created: function() {
        // AWS Identity Check
        AWS.config.region = 'eu-west-1'; // Region
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'eu-west-1:29a3ccbb-f1e8-4801-87cb-171af721855a'
        });

      },

      ready: function() {

        var main = this;
        var stripe = Stripe('pk_test_iFA4WGrOjzFb9pgHretwnXlq');
        var elements = stripe.elements();

        var card_num = this.queryEffectiveChildren('#card_code');
        var card_exp = this.queryEffectiveChildren('#card_date');
        var card_cvc = this.queryEffectiveChildren('#card_sec');
        var error_el = this.queryEffectiveChildren('#card_errors');
        var paymentButton = this.$.pay_now;
        
        var style = {
          style: {
            base: {
              fontSize: '16px',
              lineHeight: '24px',
              color: 'rgba(236,239,241 ,1)',
              '::placeholder': {
                color: 'rgba(69,90,100 ,1)',
              },
            }
          }
        };

        // Create Stripe elements from raw elements
        var cardNumber = elements.create('cardNumber', style);
        var cardExpiry = elements.create('cardExpiry', style);
        var cardCvc = elements.create('cardCvc', style);
        // Mount elements
        cardNumber.mount(card_num);
        cardExpiry.mount(card_exp);
        cardCvc.mount(card_cvc);

        cardNumber.addEventListener('change', function(event) {
          error_el.textContent = event.error ? event.error.message : '';
        });

        console.log(paymentButton);

        paymentButton.addEventListener('click', function(event) {
          stripe.createToken(cardNumber).then(function(result) {
            if (result.error) {
              // Inform the user if there was an error
              error_el.textContent = result.error.message;
              console.log(result.error.message);
            } else {
              // Send the token to your server
              console.log(result);
              // stripeTokenHandler(result.token);
            }
          });

        });

        // function stripeTokenHandler(token) {
        //   // Insert the token ID into the form so it gets submitted to the server
        //   var hiddenInput = document.createElement('input');
        //   hiddenInput.setAttribute('type', 'hidden');
        //   hiddenInput.setAttribute('name', 'stripeToken');
        //   hiddenInput.setAttribute('value', token.id);
        //   form.appendChild(hiddenInput);

        //   console.log(token.id);
        //   // Submit the form
        //   // form.submit();
        // }

      },

      sendPayment: function() {
        this.fire('stripe', {});
      },

      send: function() {

            // Lambda service object
            var lambda = new AWS.Lambda({
                region: 'eu-west-1',
                apiVersion: '2015-03-31'
            });

            // Lambda invoke params
            var lambdaParams = {
                FunctionName : 'pay-stripe',
                InvocationType : 'RequestResponse',
                LogType: 'Tail',
                Payload: JSON.stringify({
                    "order": this.order,
                    "cost": this.totalCost
                }),
            };

            // Lambda invoke!
            var main = this;
            lambda.invoke(lambdaParams, function(err, data) {
              if (err) result(err);
                else result(data.StatusCode);
            });
            
        },

    });
  </script>
</dom-module>
